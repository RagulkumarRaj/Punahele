<!DOCTYPE html>
<html>
<head>
<title>Test streaming over WebSockets</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<script src="utils/decoder.js"></script>
<script language="javascript" type="text/javascript">
	var wsUri = "ws://localhost:8080/Punahele/requestVideoAsImages";
	function init() {
		websocket = new WebSocket(wsUri);
		websocket.onmessage = function(evt) {
			var imageData = JSON.parse(evt["data"]);
			//make sure to decode imageSeqs and framePos
			var frameData = b64ToArray(imageData["image_sequences"]);
			var framePos = (imageData["start_positions_frames"]).split(",");
			for (var i = 0; i < framePos.length - 1; i++) {
                if(i == framePos.length - 1){
                	var frame = b64ToBlob(frameData.slice(framePos[i], frameData.length), "image/jpeg");
    				setTimeout(readImageData(frame), 300);
                }
                else{
                	var frame = b64ToBlob(frameData.slice(framePos[i], framePos[i + 1]), "image/jpeg");
    				setTimeout(readImageData(frame), 300);	
                }
			}
		};
	}
	
	function readFile(fileData) {
		var video = document.getElementById('area');
		video.src = window.URL.createObjectURL(fileData);
	}

	function readImageData(imageData) {
		var image = document.getElementById('frame');
		image.src = window.URL.createObjectURL(imageData);
	}

	function createObjectURL(file) {
		if (window.webkitURL) {
			return window.webkitURL.createObjectURL(file);
		} else if (window.URL && window.URL.createObjectURL) {
			return window.URL.createObjectURL(file);
		} else {
			return null;
		}
	}
	function startVideo() {
		var message = JSON.stringify({
			"frameStartPos" : "1",
			"frameEndPos" : "998"
		});
		websocket.send(message);
	}
	window.addEventListener("load", init, false);
</script>
</head>


<body>
	<h2 style="text-align: center;">Punahele - Video Streaming Service</h2>
	<div style="text-align: center;">
		<input onclick="startVideo()" value="Start video" type="button">
	</div>
	<div>
		<img id='frame'></img>
	</div>

</body>
</html>